# Ansible Role: ansible-role-lustre-build

## Purpose

This Ansible role automates the process of compiling **Lustre client components** from source code and generating RPM packages. It is designed to work on **AlmaLinux 9 and compatible RHEL 9 derivatives**. Optionally, it can handle GPG key generation and RPM signing. By default, the role is configured to build Lustre client RPMs.

## Requirements

-   Ansible 2.9 or later.
-   Target machine must be **AlmaLinux 9 or a compatible RHEL 9 derivative**.
-   Internet access on the target machine for cloning the Lustre repository and downloading dependencies.
-   Sufficient disk space (e.g., 30GB+ recommended for source and build artifacts) and system resources (CPU, RAM) for compilation.
-   The **CodeReady Builder (CRB) repository (or its equivalent, e.g., `ol9_codeready_builder` for Oracle Linux) must be available on the target system; the role will attempt to enable it.**
-   If running the role as a non-privileged user (i.e., without global `become: true` in your playbook), the paths specified by `lustre_src_path` and `lustre_rpm_path` must be writable by this user. You can override these variables to point to user-writable locations.
-   If RPM signing (`lustre_sign_rpms: true`) is enabled:
    -   `gnupg` (typically `gnupg2`) and `rpm-sign` packages must be installable (the role attempts to install them).
    -   The GPG private key (identified by `lustre_gpg_key_name`) must be available in the GPG keyring of the user executing the signing tasks.

## Role Variables

The primary variables for this role are defined in `defaults/main.yml` and can be overridden in your playbook:

-   `lustre_version`: (Default: `"master"`)
    The git branch, tag, or commit ID of the Lustre code to clone and build.
    Examples: `"master"`, `"b2_15"`, `"2.15.4"`.

-   `lustre_src_path`: (Default: `"/usr/local/src/lustre"`)
    The base directory on the target machine where the Lustre source code will be cloned. The actual checkout will be in a subdirectory named `lustre-release-{{ lustre_version }}`.

-   `lustre_rpm_path`: (Default: `"/opt/lustre_rpms"`)
    The base directory on the target machine where the compiled RPMs will be stored. RPMs for a specific version will be placed in a subdirectory named `{{ lustre_version }}`.

-   `lustre_sign_rpms`: (Default: `false`)
    A boolean value indicating whether to sign the compiled RPMs.

-   `lustre_gpg_key_name`: (Default: `""`)
    The GPG key identifier (e.g., email address, Key ID, or full name) to use for signing RPMs. This key must exist in the GPG keyring of the user performing the signing, unless `lustre_generate_gpg_key_if_missing` is true.
    Example: `"Your Name <your.email@example.com>"`.

-   `lustre_generate_gpg_key_if_missing`: (Default: `false`)
    If `true`, the role will attempt to generate a new GPG key pair if the key specified by `lustre_gpg_key_name` is not found.
    **Security Warning**: Automated GPG key generation is provided for convenience in development or testing. For production environments, it is strongly recommended to manage GPG keys securely and independently of this role.

-   `lustre_gpg_key_type`: (Default: `"RSA"`) Type for the new GPG key if generated (e.g., RSA, DSA, ECC).
-   `lustre_gpg_key_length`: (Default: `"2048"`) Length for the new GPG key if generated.
-   `lustre_gpg_key_expire_date`: (Default: `"0"`) Expiration date for the new GPG key if generated (0 for no expiration).
-   `lustre_gpg_real_name`: (Default: `"Lustre Build Key"`) Real name for the new GPG key if generated.
-   `lustre_gpg_comment`: (Default: `"Auto-generated by Ansible for Lustre RPM signing"`) Comment for the new GPG key if generated.
-   `lustre_gpg_email`: (Default: `"lustrebuilder@localhost"`) Email for the new GPG key if generated. This will also be part of the `lustre_gpg_key_name` if a key is generated.

-   `lustre_gpg_passphrase`: (Default: `""`)
    Passphrase for the GPG key. **Setting this directly is less secure** as it may be exposed in logs or Ansible variables. Prefer `lustre_gpg_passphrase_file`. If both are empty, signing assumes a passphrase-less key or that `gpg-agent` is handling it.

-   `lustre_gpg_passphrase_file`: (Default: `""`)
    Path to a file on the Ansible controller or target machine (depending on lookup context if used directly) containing the GPG key passphrase. This is the recommended method for providing a passphrase. The role creates a temporary, secured file on the target for `rpmsign`.
    Example: `"/path/to/secure/gpg_passphrase.txt"`.

-   `lustre_gpg_home`: (Default: `""`)
    Path to a custom GPG home directory (e.g., `~/.gnupg` or `/var/lib/rpm-gpg`). If empty, uses the default GPG home directory of the user executing the tasks.

Internal variables used by the role (defined in `vars/main.yml`) include:
-   `lustre_checkout_path`: Calculated full path to the Lustre source code checkout.
-   `lustre_version_rpm_path`: Calculated full path where RPMs for the specific `lustre_version` will be stored.

## Dependencies

This role will attempt to install necessary build dependencies using the `dnf` package manager. Key dependencies include:
- Standard development tools (gcc, make, automake, etc.).
- `kernel-devel` for the running kernel.
- `perl-ExtUtils-MakeMaker`.
- Specific Lustre build requirements such as `openmpi-devel`, `libnl3-devel`, `kernel-abi-stablelists`, and `kernel-rpm-macros`.
- The role will attempt to enable the CodeReady Builder (CRB) repository (or its equivalent for RHEL derivatives like `ol9_codeready_builder`) to satisfy some of these dependencies.
- If `lustre_sign_rpms` is `true`, `gnupg` (typically `gnupg2`) and `rpm-sign` packages will also be installed.
These package installation steps require privilege escalation (e.g., `become: true`).

## Example Playbook

Here is an example of how to use this role in a playbook (a `playbook.yml` file is not included in the role itself):

```yaml
---
- name: Build Lustre RPMS
  hosts: localhost # Or your target build machine, e.g., 'buildservers'
  connection: local # If hosts is localhost. Remove if targeting remote build machine.
  gather_facts: true # Good to have facts, especially for ansible_os_family

  # vars:
    # Override any defaults from the role here if needed for testing
    # lustre_version: "2.15.3" # Example: Test a specific version
    # lustre_sign_rpms: true
    # lustre_gpg_key_name: "Your GPG Key ID For Testing"
    # lustre_gpg_passphrase_file: "/path/to/your/gpg_passphrase_file.txt"
    # lustre_src_path: "/home/myuser/lustre_build/src" # Example for non-privileged path
    # lustre_rpm_path: "/home/myuser/lustre_build/rpms" # Example for non-privileged path

  roles:
    - ansible-role-lustre-build # Assumes role is in a standard Ansible roles path
```

## Usage Notes

-   **Permissions and `become`**:
    -   Tasks related to package installation (EPEL, CRB, build dependencies, `gnupg`, `rpm-sign`) use `become: true` and require root privileges.
    -   Other tasks (directory creation for source/RPMs, git cloning, compilation, GPG key generation, RPM signing) are designed to run with the privileges of the Ansible user. If you are not running the playbook with global `become: true`, ensure that the directories specified by `lustre_src_path` and `lustre_rpm_path` (and `lustre_gpg_home` if set to a non-default path) are writable by the Ansible user, or override these variables to point to user-writable paths.
-   **OpenMPI PATH Handling**: To ensure `mpicc` and other OpenMPI tools are available during compilation, the role temporarily prepends `/usr/lib64/openmpi/bin` to the `PATH` environment variable for the core build tasks (`autogen.sh`, `configure`, `make rpms`). It also adds this path to the Ansible user's `~/.bashrc` for future interactive sessions, ensuring it's available if the user logs in to continue work or troubleshoot. This `.bashrc` modification is done idempotently using a marked block.
-   **RPM Signing**:
    -   The role now uses direct shell commands for `gpg` (key generation) and `rpmsign` (signing RPMs).
    -   **GPG Key Handling**:
        -   If `lustre_sign_rpms` is `true`, you must provide `lustre_gpg_key_name`.
        -   If the specified key is not found, and `lustre_generate_gpg_key_if_missing` is `true`, the role attempts to generate a new GPG key pair using the `lustre_gpg_*` variables (e.g., `_real_name`, `_email`, `_key_type`, etc.). **This is a security risk for production; manage keys externally.**
        -   The GPG private key must be accessible to the user performing the signing tasks.
    -   **Passphrase Handling**:
        -   If the GPG key requires a passphrase:
            -   The recommended way is to set `lustre_gpg_passphrase_file` to a path containing the passphrase.
            -   Alternatively, `lustre_gpg_passphrase` can be set directly (less secure).
            -   The role creates a temporary file on the target to securely pass the passphrase to `rpmsign` and deletes it immediately after.
            -   If neither is provided, signing assumes a passphrase-less key or that `gpg-agent` is configured to provide the passphrase.
-   **Kernel Version**: Lustre compilation is sensitive to the `kernel-devel` package version. The role installs `kernel-devel` for the running kernel by default.
-   **Compilation Time**: Lustre compilation can be a lengthy process.
-   **Idempotency**:
    -   The role now includes checks to avoid re-running build and signing tasks if suitable RPMs already exist in the destination directory (`{{ lustre_version_rpm_path }}`).
    -   **If `lustre_sign_rpms` is `false`**: The role will skip the main build, move, and signing-prep tasks if any `*.rpm` files are found in `{{ lustre_version_rpm_path }}`. It assumes these existing RPMs are sufficient.
    -   **If `lustre_sign_rpms` is `true`**:
        -   The role checks if `*.rpm` files exist in `{{ lustre_version_rpm_path }}`.
        -   If they exist, it then verifies if *all* of these RPMs have a valid GPG signature (using `rpm --checksig`). This check confirms they are signed by *any* key and the signature is valid; it does not currently re-verify against the specific `lustre_gpg_key_name`.
        -   If RPMs exist and all are found to be signed, the main build, move, and signing tasks will be skipped.
    -   Tasks related to initial setup (like CRB/EPEL enablement, GPG dependency installation if signing is intended but RPMs are missing) might still run even if the build itself is skipped.
    -   Currently, there is no explicit variable to force a rebuild if RPMs already exist. To force a rebuild, you would need to manually remove the RPMs from the `{{ lustre_version_rpm_path }}` directory before running the role.

```
